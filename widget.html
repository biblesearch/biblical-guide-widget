<!doctype html>
<meta charset="utf-8">
<title>Bible Q&A Widget</title>
<style>
  body {
    margin: 0;
    font: 16px Georgia, serif;
    text-align: center;
    padding-top: 30px;
  }
  #form-container {
    display: inline-flex;
    align-items: center;
    gap: 10px;
    flex-wrap: wrap;
  }
  #q {
    padding: 12px 16px;
    width: 400px;
    max-width: 80%;
    font: 16px Georgia, serif;
    border: 1px solid #ccc;
    border-radius: 6px;
  }
  button {
    padding: 12px 20px;
    font: 16px Georgia, serif;
    background-color: #000;
    color: #fff;
    border: none;
    border-radius: 6px;
    cursor: pointer;
  }
  #ans {
    max-width: 800px;
    margin: 40px auto 0;
    font: 17px Georgia, serif;
    line-height: 1.6;
    text-align: left;
  }
</style>

<div id="form-container">
  <input id="q" placeholder="Ask a question about life, morality, or faith.">
  <button onclick="askBible()">Ask&nbsp;the&nbsp;Bible</button>
</div>
<div id="ans"></div>

<script>
  const endpointURL = "https://hook.eu2.make.com/1cwdrbnguf3qu8lkluwix02ewmn274fe";

  async function askBible() {
    const box = document.getElementById('ans');
    const question = document.getElementById('q').value.trim();
    if (!question) return;

    box.innerHTML = '<em>Processingâ€¦</em>';

    // Load conversation history from session
    let history = sessionStorage.getItem('chatHistory');
    history = history ? JSON.parse(history) : [];

    // Add user question
    history.push({ role: "user", content: question });

    try {
      // Send entire conversation history to backend
      const r = await fetch(endpointURL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ history })
      });

      if (!r.ok) throw new Error("Server error");

      const answerHTML = await r.text();

      // Show formatted response
      const [summary, ...verses] = answerHTML.split(/\n|<br\s*\/?>/).filter(Boolean);
      box.innerHTML = `
        <p style="font-style: italic; font-weight: bold;">${summary.trim()}</p>
        ${verses.map(v =>
          `<p style="margin: 4px 0; font-style: normal; font-weight: normal;">${v.trim()}</p>`
        ).join('')}
      `;

      // Add assistant's reply to history
      history.push({ role: "assistant", content: answerHTML });
      sessionStorage.setItem('chatHistory', JSON.stringify(history));

    } catch (err) {
      box.innerHTML = '<span style="color:red">Error contacting server.</span>';
      console.error(err);
    }
  }
</script>

